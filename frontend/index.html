<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Sistema de Gesti√≥n Acad√©mica</title>
    <style>
        /* Estilos Base y Tipograf√≠a */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #eef2f7; /* Gris claro profesional */
            color: #333;
        }
        .container { 
            max-width: 700px; 
            margin: 30px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        }
        /* Colores Tem√°ticos */
        .header {
            background-color: #3f51b5; /* Azul institucional */
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin: -30px -30px 20px -30px;
            text-align: center;
        }
        h1 { margin: 0; font-size: 1.8em; }
        h2 { 
            border-bottom: 2px solid #3f51b5; 
            padding-bottom: 5px; 
            margin-top: 25px; 
            color: #3f51b5;
            font-size: 1.4em;
        }

        /* Formulario y Controles */
        input[type="text"], input[type="password"] { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            box-sizing: border-box; 
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #5c6bc0;
            outline: none;
        }

        /* Botones */
        button { 
            background-color: #4CAF50; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #45a049; }
        .btn-primary { background-color: #3f51b5; }
        .btn-primary:hover { background-color: #303f9f; }
        .btn-danger { background-color: #f44336; }
        .btn-danger:hover { background-color: #d32f2f; }
        
        /* Mensajes de Estado */
        #message { 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 6px; 
            display: none; 
            font-weight: bold;
        }
        .success { background-color: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }
        .error { background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }

        /* Secci√≥n Protegida */
        #protectedSection { 
            margin-top: 30px; 
            padding: 20px; 
            background-color: #f9f9f9; 
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: none; 
        }
        /* Secci√≥n B√°sica para Estudiantes */
        #basicSection {
            margin-top: 30px;
            padding: 20px;
            background-color: #e3f2fd; /* Azul muy claro para estudiante */
            border-radius: 8px;
            border: 1px solid #bbdefb;
            display: none;
            text-align: center;
        }


        /* Token Display FIX */
        .token-box {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff8e1; /* Fondo amarillo suave para destacar la seguridad */
            border: 1px dashed #ffb300;
            border-radius: 6px;
        }
        #tokenTextarea {
            width: 100%;
            height: 80px; /* Alto fijo, con scroll si es necesario */
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
        }

        /* Tablas */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        th, td { 
            border: 1px solid #e0e0e0; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #bbdefb; /* Azul m√°s claro */
            color: #333;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>EduTrack</h1>
            <p>Sistema de Gesti√≥n Acad√©mica - NestJS Backend</p>
        </div>
        
        <h2>Acceso al Sistema</h2>
        <form id="loginForm">
            <label for="correo">Correo:</label>
            <input type="text" id="correo" name="correo" value="profesor@test.com" required>
            
            <label for="contrase√±a">Contrase√±a:</label>
            <input type="password" id="contrase√±a" name="contrase√±a" value="password" required>
            
            <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
        </form>
        
        <div id="message"></div>
        
        <div id="basicSection">
            <h2>Bienvenido al Sistema</h2>
            <p id="welcomeMessage">Cargando...</p>
            <button id="logoutButtonBasic" class="btn-danger">Cerrar Sesi√≥n</button>
        </div>


        <div id="protectedSection">
            <h2>Gesti√≥n de Datos (Ruta Protegida)</h2>
            
            <div class="token-box">
                <label>Token JWT (Copie el valor completo para Postman):</label>
                <textarea id="tokenTextarea" readonly>Inicie sesi√≥n para ver el token.</textarea>
            </div>

            <button id="fetchUsersButton" class="btn-primary">Cargar Usuarios (GET /usuarios)</button>
            <button id="logoutButton" class="btn-danger">Cerrar Sesi√≥n</button>

            <h3>Lista de Usuarios</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre Completo</th>
                        <th>Correo</th>
                        <th>Rol</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="4">Inicia sesi√≥n y haz clic en 'Cargar Usuarios'</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // La URL base de tu API de NestJS
        const API_BASE_URL = 'http://localhost:3000'; 
        let accessToken = localStorage.getItem('accessToken') || null;

        const loginForm = document.getElementById('loginForm');
        const messageDiv = document.getElementById('message');
        const protectedSection = document.getElementById('protectedSection');
        const basicSection = document.getElementById('basicSection');
        const tokenTextarea = document.getElementById('tokenTextarea');
        const fetchUsersButton = document.getElementById('fetchUsersButton');
        const usersTableBody = document.getElementById('usersTableBody');
        const logoutButton = document.getElementById('logoutButton');
        const logoutButtonBasic = document.getElementById('logoutButtonBasic');
        const welcomeMessage = document.getElementById('welcomeMessage');

        // Funci√≥n para decodificar el PAYLOAD del JWT
        function decodeToken(token) {
            try {
                // El JWT tiene el formato header.payload.signature
                const base64Url = token.split('.')[1];
                // Reemplaza caracteres seguros para URL y decodifica
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload); 
            } catch (e) {
                console.error("Error decodificando el token:", e);
                return { rol: null, nombre_completo: 'Usuario Desconocido' };
            }
        }

        // Funci√≥n para mostrar mensajes
        function displayMessage(text, isSuccess) {
            messageDiv.textContent = text;
            messageDiv.className = isSuccess ? 'success' : 'error';
            messageDiv.style.display = 'block';
        }

        // Funci√≥n para alternar la vista de secciones basada en el ROL
        function updateUI() {
            // 1. Ocultar todo por defecto
            loginForm.style.display = 'block';
            protectedSection.style.display = 'none';
            basicSection.style.display = 'none';
            tokenTextarea.value = 'Inicie sesi√≥n para ver el token.';
            usersTableBody.innerHTML = '<tr><td colspan="4">Inicia sesi√≥n y haz clic en \'Cargar Usuarios\'</td></tr>';
            messageDiv.style.display = 'none'; // Limpiar mensajes al cambiar la UI

            if (accessToken) {
                const payload = decodeToken(accessToken);
                const userRole = payload.rol;
                const userName = payload.nombre_completo || payload.correo; // Usar el nombre si existe, sino el correo.
                
                // 2. Ocultar el formulario de login y mostrar el bot√≥n de cerrar sesi√≥n
                loginForm.style.display = 'none';

                if (userRole === 'profesor') {
                    // L√ìGICA PARA PROFESORES (Admin)
                    protectedSection.style.display = 'block';
                    tokenTextarea.value = accessToken; 
                    welcomeMessage.textContent = `¬°Hola, ${userName}! (Rol: Profesor). Tienes acceso a la gesti√≥n completa del sistema.`;
                    displayMessage(`Login exitoso. Bienvenido, ${userName}.`, true);
                    basicSection.style.display = 'block'; // Usamos la basicSection para mostrar el saludo
                    // Ocultamos el bot√≥n de logout de la basicSection, usamos el de protectedSection
                    document.getElementById('logoutButtonBasic').style.display = 'none'; 
                } else if (userRole === 'estudiante') {
                    // L√ìGICA PARA ESTUDIANTES
                    basicSection.style.display = 'block';
                    welcomeMessage.textContent = `¬°Hola, ${userName}! (Rol: Estudiante). Est√°s conectado. Usa Postman para probar tus rutas personales.`;
                    document.getElementById('logoutButtonBasic').style.display = 'inline-block';
                } else {
                    // Si el token no tiene un rol v√°lido (o es inv√°lido)
                    displayMessage('‚ùå Token inv√°lido. Por favor, inicia sesi√≥n de nuevo.', false);
                    localStorage.removeItem('accessToken');
                    accessToken = null;
                    loginForm.style.display = 'block';
                }
            }
        }

        // ----------------------------------------------------
        // 1. INICIO DE SESI√ìN (POST /auth/login)
        // ----------------------------------------------------
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                correo: document.getElementById('correo').value,
                contrase√±a: document.getElementById('contrase√±a').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Credenciales inv√°lidas.');
                }

                const result = await response.json();
                accessToken = result.access_token;
                localStorage.setItem('accessToken', accessToken);
                
                // Si el login es exitoso, actualizamos la UI para ver la secci√≥n correcta
                updateUI();
                
            } catch (error) {
                displayMessage('‚ùå Error al iniciar sesi√≥n: ' + error.message, false);
            }
        });

        // ----------------------------------------------------
        // 2. CARGAR USUARIOS (GET /usuarios - Ruta Protegida)
        // ----------------------------------------------------
        fetchUsersButton.addEventListener('click', async () => {
            if (!accessToken) {
                return displayMessage('‚ö†Ô∏è Debes iniciar sesi√≥n primero.', false);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/usuarios`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`, // üëà ENV√çO DEL TOKEN JWT
                        'Content-Type': 'application/json',
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    displayMessage('‚ùå Acceso no autorizado. El token es v√°lido, pero el servidor deneg√≥ el rol (403 Forbidden).', false);
                    // Borrar token si es no autorizado (para evitar intentos fallidos futuros)
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    updateUI();
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error desconocido al cargar usuarios.');
                }

                const users = await response.json();
                
                // Mapeo din√°mico de los usuarios a la tabla
                usersTableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.nombre_completo}</td>
                        <td>${user.correo}</td>
                        <td>${user.rol}</td>
                    </tr>
                `).join('');

                displayMessage(`Se cargaron ${users.length} usuarios.`, true);

            } catch (error) {
                displayMessage('‚ùå Error al obtener datos: ' + error.message, false);
            }
        });

        // ----------------------------------------------------
        // 3. CERRAR SESI√ìN
        // ----------------------------------------------------
        const handleLogout = () => {
            accessToken = null;
            localStorage.removeItem('accessToken');
            displayMessage('üö™ Sesi√≥n cerrada correctamente.', true);
            updateUI();
        };

        logoutButton.addEventListener('click', handleLogout); // Bot√≥n de Profesor
        logoutButtonBasic.addEventListener('click', handleLogout); // Bot√≥n de Estudiante

        // Inicializar la interfaz
        updateUI();

    </script>
</body>
</html>